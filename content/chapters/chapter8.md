---
typora-root-url: ./..\..\public
---

# 第 8 章 查询处理 (Chapter 8 Query Processing)

接下来的三章将探讨数据库引擎如何执行 SQL 查询。问题在于 SQL 查询指定了要返回什么数据，但没有指定如何获取这些数据。解决方案是让引擎实现一组数据检索操作符，称为**关系代数 (relational algebra)**。引擎可以将 SQL 查询翻译成关系代数查询，然后执行。本章将介绍关系代数查询及其实现。接下来的两章将探讨 SQL 到关系代数的翻译。

## 8.1 关系代数 (Relational Algebra)

关系代数由一组操作符组成。每个操作符执行一个专门的任务，接受一个或多个表作为输入，并产生一个输出表。可以通过以各种方式组合这些操作符来构建复杂的查询。

SimpleDB 版本的 SQL 可以使用以下三个操作符来实现：

- **选择 (select)**：其输出表与输入表具有相同的列，但删除了一些行。
- **投影 (project)**：其输出表与输入表具有相同的行，但删除了一些列。
- **乘积 (product)**：其输出表由其两个输入表的所有可能记录组合组成。

这些操作符将在以下小节中进行探讨。

### 8.1.1 选择 (Select)

**选择 (select)** 操作符接受两个参数：一个输入表和一个谓词。输出表由满足谓词的输入记录组成。选择查询总是返回一个与输入表具有相同模式但记录是其子集的表。

例如，查询 Q1 返回一个列出 2019 年毕业的学生的表。

`Q1=select(STUDENT,GradYear=2019)`

谓词可以是项的任何布尔组合，对应于 SQL 中的 `WHERE` 子句。例如，查询 Q2 查找那些 2019 年毕业且专业为 10 或 20 部门的学生。

`Q2=select(STUDENT,GradYear=2019 and (MajorId=10 or MajorId=20))`

一个查询的输出表可以作为另一个查询的输入。例如，查询 Q3 和 Q4 都等价于 Q2：

`Q3=select(select(STUDENT,GradYear=2019),MajorId=10 or MajorId=20)`

`Q4=select(Q1,MajorId=10 or MajorId=20)`

在 Q3 中，最外层查询的第一个参数是另一个查询，与 Q1 相同，它查找 2019 年毕业的学生。外层查询从这些记录中检索 10 或 20 部门的学生。查询 Q4 类似，只是它使用 Q1 的名称代替了其定义。

关系代数查询可以用图形表示，作为**查询树 (query tree)**。查询树包含查询中提到的每个表和操作符的节点。表节点是树的叶子，操作符节点是非叶子。操作符节点为其每个输入表都有一个子节点。例如，Q3 的查询树如 图 8.1 所示。

**图 8.1 Q3 的查询树 (A query tree for Q3)**

```txt
           select MajorId=10 or MajorId=20
              |   
           select GradYear=2019
              | 
           STUDENT 
```

### 8.1.2 投影 (Project)

**投影 (project)** 操作符接受两个参数：一个输入表和一组字段名。输出表与输入表具有相同的记录，但其模式只包含那些指定的字段。例如，查询 Q5 返回所有学生的姓名和毕业年份：

`Q5=project(STUDENT,{SName,GradYear})`

一个查询可以由投影和选择操作符组成。查询 Q6 返回一个列出所有主修 10 部门的学生的姓名的表：

`Q6=project(select(STUDENT,MajorId=10),{SName})`

Q6 的查询树如 图 8.2 所示。

**图 8.2 Q6 的查询树 (A query tree for Q6)**

```txt
           project {SName}
             |
           select  MajorId=10
             |       
           STUDENT 
```

投影查询的输出表可能包含重复记录。例如，如果有三个名叫“pat”且专业为 10 的学生，则 Q6 的输出将包含“pat”三次。

并非所有操作符的组合都有意义。例如，考虑通过反转 Q6 得到的查询：

`Q7=select(project(STUDENT,{SName}),MajorId=10) // 不合法！`

这个查询没有意义，因为内部查询的输出表不包含可以进行选择的 `MajorId` 字段。

### 8.1.3 乘积 (Product)

选择和投影操作符作用于单个表。**乘积 (product)** 操作符使得组合和比较来自多个表的信息成为可能。该操作符接受两个输入表作为参数。其输出表由输入表的所有记录组合组成，其模式由输入模式中字段的并集组成。输入表必须具有不相交的字段名，以便输出表不会有两个同名字段。

**图 8.3 查询 Q8 的输出 (The output of query Q8)**

这是 STUDENT 表和 DEPT 表的乘积结果示例。

假设 STUDENT 表有字段 (SId, SName, MajorId, GradYear)，DEPT 表有字段 (DId, DName)。

Q8 的输出将是：

| **SId** | **SName** | **MajorId** | **GradYear** | **DId** | **DName** |
| ------- | --------- | ----------- | ------------ | ------- | --------- |
| 1       | joe       | 10          | 2021         | 10      | compsci   |
| 1       | joe       | 10          | 2021         | 20      | math      |
| 1       | joe       | 10          | 2021         | 30      | drama     |
| 2       | amy       | 20          | 2020         | 10      | compsci   |
| 2       | amy       | 20          | 2020         | 20      | math      |
| 2       | amy       | 20          | 2020         | 30      | drama     |
| 3       | max       | 10          | 2022         | 10      | compsci   |
| 3       | max       | 10          | 2022         | 20      | math      |
| 3       | max       | 10          | 2022         | 30      | drama     |
| 4       | sue       | 20          | 2022         | 10      | compsci   |
| 4       | sue       | 20          | 2022         | 20      | math      |
| 4       | sue       | 20          | 2022         | 30      | drama     |
| 5       | bob       | 30          | 2020         | 10      | compsci   |
| 5       | bob       | 30          | 2020         | 20      | math      |
| 5       | bob       | 30          | 2020         | 30      | drama     |
| 6       | kim       | 20          | 2020         | 10      | compsci   |
| 6       | kim       | 20          | 2020         | 20      | math      |
| 6       | kim       | 20          | 2020         | 30      | drama     |
| 7       | art       | 30          | 2021         | 10      | compsci   |
| 7       | art       | 30          | 2021         | 20      | math      |
| 7       | art       | 30          | 2021         | 30      | drama     |
| 8       | pat       | 20          | 2019         | 10      | compsci   |
| 8       | pat       | 20          | 2019         | 20      | math      |
| 8       | pat       | 20          | 2019         | 30      | drama     |
| 9       | lee       | 10          | 2021         | 10      | compsci   |
| 9       | lee       | 10          | 2021         | 20      | math      |
| 9       | lee       | 10          | 2021         | 30      | drama     |

查询 Q8 返回 `STUDENT` 和 `DEPT` 表的乘积：

`Q8=product(STUDENT,DEPT)`

图 1.1 的大学数据库中 `STUDENT` 表有 9 条记录，`DEPT` 表有 3 条记录。图 8.3 描绘了给定这些输入表时 Q8 的输出。输出表包含 27 条记录，每条记录都是学生记录与部门记录的每个配对。通常，如果 `STUDENT` 表有 N 条记录，`DEPT` 表有 M 条记录，那么输出表将包含 N×M 条记录（顺便说一句，这就是为什么该操作符被称为“乘积”的原因）。

查询 Q8 并没有特别的意义，因为它没有考虑到每个学生的专业。这种意义可以通过选择谓词来表达，如查询 Q9 和 图 8.4 所示：

`Q9=select(product(STUDENT,DEPT),MajorId=DId)`

这个查询的输出表只包含满足谓词的 `STUDENT` 和 `DEPT` 记录的组合。因此，在 27 种可能的组合中，只有那些学生的专业 ID 与部门 ID 相同的组合会保留下来——换句话说，结果表将由学生及其所属专业的部门组成。输出表现在有 9 条记录，而不是 27 条。
